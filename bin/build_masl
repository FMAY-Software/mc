#!/bin/bash
# 
#  This utility is used to build the executable MASL tools m2x, masl, x2m
#
#   build_masl -o -o <output directory>

BPTOOLS="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/"
OUT_DIR=

# USAGE
print_usage () { 
    echo "Usage:"
    echo "        build_masl -o <output directory>"
}

# abort
abort () {
    echo "Aborting..."
    $BPTOOLS/CLI.sh Launch -abort
    exit 1
}
trap abort SIGINT SIGTERM

# parse arguments
DIRECTIVE=
for arg in $@; do
    if [[ $arg == "-o" ]]; then                             # set the directive
        DIRECTIVE=$arg
    elif [[ $DIRECTIVE == "-o" && $OUT_DIR == "" ]]; then   # only can set the output directory once
        OUT_DIR=`pwd`/$arg
        DIRECTIVE=
    else
        print_usage
        exit 1
    fi
done

if [[ $OUT_DIR == "" ]]; then
    print_usage
    exit 1
fi

echo "Setting up workspace..."

# make a temporary directory
GIT_DIR=`mktemp -d`
echo "GIT_DIR: $GIT_DIR"

# make a temporary workspace
export WORKSPACE=`mktemp -d`
echo "WORKSPACE: $WORKSPACE"

# clone the mc and bridgepoint repositories
echo "Cloning the repos..."
cd $GIT_DIR
git clone https://github.com/xtuml/mc.git --depth 1
git clone https://github.com/xtuml/bridgepoint.git --depth 1

# launch an eclipse instance
echo "Launching an Eclipse command line instance..."
$BPTOOLS/CLI.sh Launch -workspacePreferences "bridgepoint_prefs_allow_operations_in_where=true"

# import the projects
echo "Importing projects..."
$BPTOOLS/CLI.sh Import -project $GIT_DIR/bridgepoint/src/org.xtuml.bp.ui.marking/
$BPTOOLS/CLI.sh Import -project $GIT_DIR/mc/model/mcooa/
$BPTOOLS/CLI.sh Import -project $GIT_DIR/mc/model/mcshared/
$BPTOOLS/CLI.sh Import -project $GIT_DIR/mc/model/masl/
$BPTOOLS/CLI.sh Import -project $GIT_DIR/mc/model/maslin/
$BPTOOLS/CLI.sh Import -project $GIT_DIR/mc/model/maslout/

# build the projects
echo "Building projects..."
$BPTOOLS/CLI.sh Build -project masl
$BPTOOLS/CLI.sh Build -project maslin
$BPTOOLS/CLI.sh Build -project maslout

# shutdown eclipse instance
$BPTOOLS/CLI.sh Launch -exit

# archive the source
cd $WORKSPACE
mkdir src
cp -r $WORKSPACE/masl/src src/masl-src
cp -r $WORKSPACE/maslin/src src/maslin-src
cp -r $WORKSPACE/maslout/src src/maslout-src
zip -r maslsrc.zip src/

# compile the projects
echo "Compiling projects..."
cd $WORKSPACE/masl/src
make -f makefile.masl
cd $WORKSPACE/maslin/src
make -f makefile.maslin
cd $WORKSPACE/maslout/src
make -f makefile.maslout

# make the output directory
mkdir $OUT_DIR

# copy the executables
cp $WORKSPACE/maslsrc.zip $OUT_DIR
cp $WORKSPACE/masl/src/mcmasl $OUT_DIR
cp $WORKSPACE/maslin/src/m2x $OUT_DIR
cp $WORKSPACE/maslout/src/x2m $OUT_DIR
mv $OUT_DIR/mcmasl $OUT_DIR/masl

echo "Done."
